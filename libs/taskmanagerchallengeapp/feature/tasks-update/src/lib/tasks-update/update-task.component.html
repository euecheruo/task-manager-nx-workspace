<div class="row justify-content-center mt-5">
  <div class="col-lg-8">

    @if (loading()) {
    <div class="text-center p-5">
      <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
      <p class="mt-2 text-muted">Loading Task Details...</p>
    </div>
    }

    @if (!loading() && taskDetails()) {
    <div class="card shadow-lg rounded-4 border-0">
      <div class="card-header bg-warning text-dark p-4 rounded-top-4">
        <h3 class="mb-0 fw-bold">Update Task ID: {{ taskId() }}</h3>
        <small class="text-muted">
          Creator: {{ taskDetails()!.creator.email || 'Unknown User' }}
        </small>
      </div>

      <div class="card-body p-4 p-md-5">

        @if (errorMessage()) {
        <div class="alert alert-danger rounded-3 p-2 mb-4 text-center" role="alert">
          {{ errorMessage() }}
        </div>
        }

        <form (ngSubmit)="onSubmit()" #taskForm="ngForm">

          <div class="mb-4">
            <label for="title" class="form-label fw-medium">Task Title <span class="text-danger">*</span></label>
            <input type="text"
                   class="form-control rounded-3"
                   id="title"
                   [(ngModel)]="title"
                   name="title"
                   required
                   [disabled]="!canEditCoreDetails()"
                   placeholder="Task Title">
            @if (!canEditCoreDetails()) {
            <small class="form-text text-muted">Title/Description modification requires 'update:own:tasks' permission and being the task creator.</small>
            }
          </div>

          <div class="mb-4">
            <label for="description" class="form-label fw-medium">Description</label>
            <textarea class="form-control rounded-3"
                      id="description"
                      [(ngModel)]="description"
                      name="description"
                      rows="4"
                      [disabled]="!canEditCoreDetails()"
                      placeholder="Detailed steps and requirements."></textarea>
          </div>

          <div class="form-check form-switch mb-4 p-4 border rounded-3"
               [class.border-success]="isCompleted()"
               [class.bg-light]="isCompleted()"
               [title]="canToggleCompletion()? 'Toggle completion status' : 'You must be the assigned user to toggle completion status'">

            <input class="form-check-input"
                   type="checkbox"
                   role="switch"
                   id="isCompletedSwitch"
                   [ngModel]="isCompleted()"
                   (ngModelChange)="onCompletionToggle($event)"
                   name="isCompleted"
                   [disabled]="!canToggleCompletion()">

            <label class="form-check-label fw-bold" for="isCompletedSwitch">
              Mark task as {{ isCompleted()? 'Completed' : 'Incomplete' }}
            </label>
            @if (!canToggleCompletion()) {
            <small class="form-text text-danger d-block">This action requires you to be the assigned user and possess the correct permission (mark/unmark).</small>
            }
          </div>

          <div class="mb-5">
            <label for="assignedUser" class="form-label fw-medium">Assign To User</label>
            <select id="assignedUser"
                    class="form-select rounded-3"
                    [(ngModel)]="assignedUserId"
                    name="assignedUser"
                    [disabled]="!canEditCoreDetails() || users().length === 0">
              <option [ngValue]="null">-- Unassigned --</option>
              @for (user of users(); track user.userId) {
              <option [ngValue]="user.userId">{{ user.email }}</option>
              }
            </select>
          </div>

          <div class="d-flex justify-content-between pt-3 border-top">
            <button type="button"
                    class="btn btn-outline-secondary rounded-pill px-4"
                    (click)="onCancel()">
              Cancel
            </button>

            <button type="submit"
                    class="btn btn-warning btn-lg rounded-pill px-5 shadow-sm"
                    [disabled]="isSaving() || taskForm.invalid ||!canEditCoreDetails()"
                    *appHasPermission="'update:own:tasks'">
              @if (isSaving()) {
              <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
              Saving...
              } @else {
              Update Core Details
              }
            </button>
          </div>
        </form>
      </div>
    </div>
    }
    @if (!loading() &&!taskDetails()) {
    <div class="alert alert-warning text-center">
      Task details not available or access denied.
    </div>
    }
  </div>
</div>
